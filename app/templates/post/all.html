{% extends 'main/base.html' %}

{% block title %}Theme Portal{% endblock %}

{% block style %}
<link rel="stylesheet" href="{{url_for('static', filename='css/libs/all.min.css') }}">
<link rel="stylesheet" href="{{url_for('static', filename='css/themes.css') }}">
{% endblock %}

{% block content %}
<div class="welcome-section text-center text-white">
    <div class="welcome-overlay"></div>
    <div class="welcome-content container py-5">
        <img src="{{ url_for('static', filename='img/student-phone-80.png') }}" alt="Logo" class="logo mb-3"
             width="80"
             height="80"
             loading="lazy"
        >
        <h1 class="display-5 fw-bold">Welcome to the Theme Portal</h1>
        <p class="lead">Here you can filter, manage, and review all student-submitted themes in one place.</p>
    </div>
</div>

<h1>All Themes</h1>

<form method="post" class="row g-2 align-items-end mb-4" id="teacherForm">
    {{ form.csrf_token }}

    <div class="col-md-3">
        {{ form.teacher.label(class="form-label") }}
        {{ form.teacher(class="form-select form-select-sm") }}
    </div>

    <div class="col-md-3">
        {{ form.discipline_filter.label(class="form-label") }}
        {{ form.discipline_filter(class="form-select form-select-sm") }}
    </div>

    <div class="col-md-3">
        {{ form.group_filter.label(class="form-label") }}
        {{ form.group_filter(class="form-select form-select-sm") }}
    </div>

    <div class="col-md-2 d-flex align-items-center">
        <div class="form-check">
            {{ form.show_checked(class="form-check-input") }}
            {{ form.show_checked.label(class="form-check-label ms-1") }}
        </div>
    </div>

    <div class="col-md-1">
        <button type="submit" class="btn btn-success btn-sm w-100"
                style="background-color: #2e7d32; color: white;">
            Show
        </button>
    </div>
</form>

<div class="w-100 mt-4">
    <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
            <thead>
            <tr>
                <th scope="col">Teacher</th>
                <th scope="col">Theme</th>
                <th scope="col">Course</th>
                <th scope="col">Group</th>
                <th scope="col">Student</th>
                <th scope="col">Deadline</th>
                <th scope="col">Status</th>
                <th scope="col">Comments</th>
                {% if current_user.is_authenticated %}
                <th scope="col">Student File</th>
                <th scope="col">Student Comments</th>
                <th scope="col">Actions</th>
                {% endif %}
            </tr>
            </thead>
            <tbody>
            {% for post in posts %}
            <tr>
                <td data-label="Teacher">
                    <div class="teacher-name">
                        <img src="{% if post.author.avatar %}{{ url_for('static', filename='upload/' + post.author.avatar) }}{% else %}{{ url_for('static', filename='img/default-min.jpg') }}{% endif %}"
                             alt="Teacher" class="avatar">
                        {{ post.author.name }}
                    </div>
                </td>
                <td data-label="Theme">{{ post.subject }}</td>
                <td data-label="Course">{{ post.discipline }}</td>
                <td data-label="Group">{{ post.group_number }}</td>
                <td data-label="Student">
                    {% with student = user.query.get(post.student) %}
                    <div class="student-name">
                        <img src="{% if student.avatar %}{{ url_for('static', filename='upload/' + student.avatar) }}{% else %}{{ url_for('static', filename='img/default-min.jpg') }}{% endif %}"
                             alt="Student" class="avatar"
                             width="58.75"
                             height="58.75"
                             loading="lazy"
                        >
                        {{ student.name }}
                    </div>
                    {% endwith %}
                </td>
                <td data-label="Deadline">
                    {% if post.deadline %}
                    {{ post.deadline.strftime('%Y-%m-%d') }}
                    {% if post.is_deadline_passed() %}
                    <span class="badge bg-danger">Overdue</span>
                    {% endif %}
                    {% else %}
                    No deadline
                    {% endif %}
                </td>
                <td data-label="Status">
                    {% if post.is_checked %}
                    <span class="badge bg-success">checked</span>
                    {% else %}
                    <span class="badge bg-warning text-dark">pending</span>
                    {% endif %}
                </td>
                <td data-label="Comments">
                    {% if post.comment %}
                    {{ post.comment|truncate(50) }}
                    {% if post.comment|length > 50 %}
                    <button class="btn btn-sm btn-link" data-bs-toggle="modal"
                            data-bs-target="#commentsModal{{ post.id }}">
                        Read more
                    </button>
                    {% endif %}
                    {% else %}
                    No comments
                    {% endif %}
                </td>

                {% if current_user.is_authenticated %}
                <td data-label="Student File">
                    {% if post.teacher == current_user.id %}
                        {% if post.student_file %}
                        <a href="{{ url_for('static', filename='upload/docs/' + post.student_file) }}" target="_blank">Student file</a>
                        {% else %}
                        No file
                        {% endif %}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td data-label="Student Comment">
                    {% if post.teacher == current_user.id %}
                        {{ post.student_comment or 'No comment' }}
                    {% else %}
                    -
                    {% endif %}
                </td>
                <td data-label="Actions">
                    {% if post.author.id == current_user.id %}
                    <a href="{{ url_for('post.update', id=post.id) }}" class="btn btn-secondary btn-sm">
                        <i class="fa-solid fa-pen-to-square"></i> Change
                    </a>
                    <a href="{{ url_for('post.delete', id=post.id) }}" class="btn btn-danger btn-sm">
                        <i class="fa-solid fa-trash"></i> Delete
                    </a>
                    {% endif %}
                </td>
                {% endif %}
            </tr>

            <!-- Modal for full comments -->
            {% if post.comment and post.comment|length > 50 %}
            <div class="modal fade" id="commentsModal{{ post.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Full comment</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"
                                    aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            {{ post.comment }}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}